---
layout: center
transition: slide-left
---

# ç¬¬äºŒå€‹å„ªåŒ–æŠ€å·§ï¼šè¨˜æ†¶åŒ– (Memoization)

<!--
æˆ‘å€‘åœ¨ä¸Šä¸€ç¯€æåˆ°äº†ã€Œç‹€æ…‹ä¸‹ç§»ã€å¯ä»¥æœ‰æ•ˆç¸®å° re-render çš„ç¯„åœï¼Œä½†æœ‰äº›æƒ…æ³ï¼Œå…‰é ç‹€æ…‹ä¸‹ç§»é‚„ä¸å¤ ï¼Œæ‰€ä»¥é€™ä¸€ç« æˆ‘å€‘è¦ä¾†èŠèŠè¨˜æ†¶åŒ– (Memoization)ï¼Œä¹Ÿå°±æ˜¯ `useMemo` ä»¥åŠ useCallback
-->

---

# ç¬¬äºŒå€‹éœ€æ±‚

````md magic-move
```jsx
export default function UserProfile({ userId }) {
  const [userData, setUserData] = useState(null);

  return (
    <div>
      {userData && (
        <pre className="bg-gray-100 p-4">
          {JSON.stringify(userData, null, 2)}
        </pre>
      )}
    </div>
  );
}
```

```jsx {4-11}
export default function UserProfile({ userId }) {
  const [userData, setUserData] = useState(null);

  const requestOptions = {
    source: 'profile-component',
    timestamp: Date.now(),
  };

  const loadUserData = async options => {
    const data = await fetchUserDetails(userId, options);
    setUserData(data);
  };

  return <div>{/* å…¶ä»–ç¨‹å¼ç¢¼ */}</div>;
}
```

```jsx {7-16}
export default function UserProfile({ userId }) {
  const [userData, setUserData] = useState(null);

  const requestOptions = {
    source: 'profile-component',
    timestamp: Date.now(),
  };

  const loadUserData = async options => {
    const data = await fetchUserDetails(userId, options);
    setUserData(data);
  };

  useEffect(() => {
    loadUserData(requestOptions);
  }, [requestOptions, loadUserData]);

  return <div>{/* å…¶ä»–ç¨‹å¼ç¢¼ */}</div>;
}
```
````

<!--
ä¸€æ¨£ï¼Œæˆ‘å€‘å…ˆå¾ä¸€å€‹éœ€æ±‚é–‹å§‹

[click]
ç¾åœ¨ç”¢å“çš„å¾Œç«¯çš„ API å¯«å¥½äº†ï¼Œæ‰€ä»¥æˆ‘å€‘è¦åœ¨é€²å…¥é é¢æ™‚å» fetch ä½¿ç”¨è€…è³‡æ–™ä¸¦é¡¯ç¤ºå‡ºä¾†ï¼Œä¸¦ä¸”éœ€è¦å¸¶ä¸€äº›åƒæ•¸ä¾†è¨˜éŒ„é€²å…¥é é¢çš„æ™‚é–“ï¼Œæ‰€ä»¥æˆ‘å€‘å¾ˆå¿«é€Ÿåœ°å¯«äº†é€™æ¨£çš„ç¨‹å¼ç¢¼

[click]
åˆ©ç”¨ loadUserData ä¾† fetch ä½¿ç”¨è€…è³‡æ–™ï¼Œä¸¦åœ¨ useEffect æ™‚å»ç²å–è³‡æ–™åŒæ™‚ setState å°‡è³‡æ–™é¡¯ç¤ºåœ¨ç•«é¢ä¸Šã€‚
-->

---

<Video>
 <source src="/ch-5/5-2/0.mp4" type="video/mp4" />
</Video>

<!--
ä¹çœ‹ä¹‹ä¸‹å¥½åƒæ²’å•é¡Œï¼ŒçµæœåŸ·è¡Œå¾Œ

å¯ä»¥å¾ç•«é¢ä¸Šå¯ä»¥çœ‹åˆ° timestamp ä¸æ–·åœ¨è®ŠåŒ–ï¼Œconsole.log ä¹Ÿä¸æ–·åœ¨è·³ï¼Œ
ä»£è¡¨é€™å€‹çµ„ä»¶æ­£åœ¨ç˜‹ç‹‚çš„å»æ‰“ API ä¸¦é‡æ–°æ¸²æŸ“ã€‚
-->

---

# ç‚ºä»€éº¼å‘¢ï¼Ÿ

<div mt-4 ml-4>

```jsx
useEffect(() => {
  loadUserData(requestOptions);
}, [requestOptions, loadUserData]); // <- å€¼æ”¹è®Šæ™‚ï¼ŒuseEffect æœƒé‡æ–°åŸ·è¡Œ
```

</div>

<!--
ç‚ºä»€éº¼å‘¢ï¼Ÿ

æˆ‘å€‘çŸ¥é“ useEffect æœƒåœ¨ä¾è³´é™£åˆ—çš„å€¼æ”¹è®Šæ™‚ï¼Œé‡æ–°åŸ·è¡Œ
-->

---
layout: center
---

# å€¼ä¸æ˜¯æ²’æœ‰è®Šå—ï¼Ÿ

<!--
ä½ å¯èƒ½æœƒç–‘æƒ‘ï¼šã€Œæ˜æ˜ requestOptions å’Œ loadUserData çš„å…§å®¹æ²’è®Šï¼Œç‚ºä»€éº¼æœƒè¢«åˆ¤å®šç‚ºæ”¹è®Šï¼Ÿã€

é€™å°±ç‰½æ¶‰åˆ° JavaScript ä¸­çš„åŸå§‹å€¼ï¼ˆprimitiveï¼‰èˆ‡åƒè€ƒå€¼ï¼ˆreferenceï¼‰çš„å·®ç•°äº†ã€‚

ä¹Ÿæ˜¯ `useMemo` å’Œ `useCallback` è¦ç”¨å¥½çš„é—œéµ
-->

---

# åŸå§‹å€¼ï¼ˆprimitiveï¼‰vs åƒè€ƒå€¼ï¼ˆreferenceï¼‰

<v-clicks>

åŸå§‹å€¼(primitive)ï¼š`number`ã€`string`ã€`boolean`ã€`null`ã€`undefined`ã€`symbol`ã€`bigint`
<br/>
åƒè€ƒå€¼(reference)ï¼š`Object`ã€`Array`ã€`Function`ã€`Date`ã€`RegExp` ç­‰ç‰©ä»¶é¡å‹

</v-clicks>

<div v-click>

```js [åŸå§‹å€¼]
const a = 42;
const b = 42;
console.log(a === b); // trueï¼Œå› ç‚ºå€¼å®Œå…¨ç›¸åŒ
```

</div>

<div v-click>

```js [åƒè€ƒå€¼ - ä¸åŒè¨˜æ†¶é«”ä½å€]
const a = { id: 1 };
const b = { id: 1 };
console.log(a === b); // false
```

</div>

<div v-click>

```js [åƒè€ƒå€¼ - ç›¸åŒè¨˜æ†¶é«”ä½å€]
const a = { id: 1 };
const b = a; // b ç›´æ¥æŒ‡å‘ a çš„ä½ç½®
console.log(a === b); // true
```

</div>

<!--
åœ¨ JavaScript ä¸­ï¼Œå€¼çš„æ¯”è¼ƒæ˜¯ä¸€å€‹æ ¸å¿ƒæ¦‚å¿µï¼Œ
è€Œåœ¨ React è£¡ï¼Œç†è§£é€™ä¸€é»æ›´æ˜¯å¯«å¥½å…ƒä»¶çš„ç¬¬ä¸€æ­¥ã€‚

JS ä¸­çš„è³‡æ–™å‹åˆ¥å¯ä»¥å¤§è‡´åˆ†ç‚ºå…©é¡ï¼š
[click]
åŸå§‹å€¼ï¼ˆPrimitiveï¼‰ï¼šnumberã€stringã€booleanã€nullã€undefinedã€symbolã€bigint

åƒè€ƒå€¼ï¼ˆReferenceï¼‰ï¼šObjectã€Arrayã€Functionã€Dateã€RegExp ç­‰ç‰©ä»¶é¡å‹


[click]
åŸå§‹å€¼å’Œåƒè€ƒå€¼çš„å·®åˆ¥åœ¨å“ªå‘¢ï¼Ÿ

åŸå§‹å€¼çš„æ¯”è¼ƒéå¸¸ç›´è§€ï¼ŒJavaScript æœƒç›´æ¥æ¯”è¼ƒå®ƒå€‘çš„å€¼æ˜¯å¦ç›¸åŒã€‚

é€™å°±åƒæˆ‘å€‘åœ¨æ¯”å°å…©å€‹ç›¸åŒçš„é›»è©±è™Ÿç¢¼ï¼Œå…§å®¹ä¸€æ¨£ï¼Œçµæœç•¶ç„¶å°±æ˜¯ç›¸ç­‰ã€‚åŸå§‹å€¼çš„æ¯”è¼ƒç°¡å–®æ˜ç­ï¼Œå› ç‚ºå®ƒå€‘ç›´æ¥å„²å­˜äº†å€¼æœ¬èº«ã€‚

[click]
ä½†ç•¶æˆ‘å€‘è«‡åˆ°ç‰©ä»¶ã€é™£åˆ—ã€å‡½æ•¸é€™äº›å¾ç‰©ä»¶ç¹¼æ‰¿çš„æ±è¥¿ï¼Œäº‹æƒ…å°±è®Šå¾—æœ‰é»è¤‡é›œäº†ã€‚

ä»–ä¸¦ä¸æ˜¯ç›´æ¥å„²å­˜å€¼æœ¬èº«ï¼Œè€Œæ˜¯å„²å­˜ä¸€å€‹ã€ŒæŒ‡å‘è¨˜æ†¶é«”çš„åƒè€ƒã€ï¼ˆreferenceï¼‰ã€‚ç°¡å–®ä¾†èªªï¼Œè®Šæ•¸è£¡è£çš„ä¸æ˜¯è³‡æ–™æœ¬èº«ï¼Œè€Œæ˜¯åƒå€‹åœ°å€ï¼Œå‘Šè¨´ä½ è³‡æ–™å­˜åœ¨å“ªè£¡ä¾†çœ‹å€‹ä¾‹å­ï¼š

é›–ç„¶ a å’Œ b çš„å…§å®¹çœ‹èµ·ä¾†ä¸€æ¨£ï¼Œä½†å®ƒå€‘åˆ†åˆ¥å„²å­˜åœ¨ä¸åŒçš„è¨˜æ†¶é«”ä½ç½®ï¼Œå› æ­¤æ¯”è¼ƒçµæœç‚º falseã€‚

[click]
è‹¥ä½ å¸Œæœ›å®ƒå€‘ç›¸ç­‰ï¼Œå”¯ä¸€çš„æ–¹å¼æ˜¯è®“å…©è€…æŒ‡å‘ç›¸åŒçš„è¨˜æ†¶é«”ä½å€ï¼š
å¯ä»¥æƒ³åƒæˆå…©å€‹äººæŒæœ‰åŒä¸€ä»½åœ°åœ–ï¼ŒæŒ‡å‘çš„æ˜¯å®Œå…¨ç›¸åŒçš„åœ°é»ã€‚
-->

---

# å° React æœ‰ä»€éº¼å½±éŸ¿ï¼Ÿ

````md magic-move
```js
useEffect(() => {
  loadUserData(requestOptions);
}, [requestOptions, loadUserData]);

// ç”±æ–¼ requestOptions, loadUserData æ˜¯åƒè€ƒå€¼
// æ‰€ä»¥æ¯æ¬¡ render æ™‚éƒ½æœƒé‡æ–°å‰µå»ºä¸€å€‹æ–°çš„ç‰©ä»¶
```

```js {1,6,8,13,14}
const requestOptions = useMemo(() => {
  return {
    source: 'profile-component',
    timestamp: Date.now(), // é€é timestamp å¯ä»¥ç™¼ç¾ä¸æ–·åœ¨ re-render
  };
}, []);

const loadUserData = useCallback(
  async options => {
    const data = await fetchUserDetails(userId, options);
    setUserData(data);
  },
  [userId]
);

useEffect(() => {
  loadUserData(requestOptions);
}, [requestOptions, loadUserData]);
```
````

<!--
å›åˆ°å‰›å‰›çš„ React å•é¡Œä¸­ï¼Œç”±æ–¼æ¯æ¬¡ re-render æ™‚ï¼ŒrequestOptions å’Œ loadUserData éƒ½æœƒè¢«é‡æ–°å‰µå»ºï¼Œå› æ­¤å®ƒå€‘çš„ã€Œåƒè€ƒå€¼ã€ä¸åŒã€‚å° React è€Œè¨€ï¼Œå³ä½¿å…§å®¹ç›¸åŒï¼Œä¹Ÿè¢«è¦–ç‚ºã€Œæ–°çš„ä¾è³´ã€ï¼ŒuseEffect å°±æœƒè¢«é‡æ–°è§¸ç™¼ã€‚

[click]
è¦è§£æ±ºé€™å€‹å•é¡Œï¼Œæˆ‘å€‘å°±å°±éœ€è¦ç”¨åˆ° `useMemo` useCallbackã€‚

é€™æ™‚ï¼Œå°±æ˜¯ `useMemo` å’Œ `useCallback` ç™»å ´çš„æ™‚å€™äº†ï¼Œé€é `useMemo` å’Œ useCallbackï¼Œæˆ‘å€‘å¯ä»¥è¨˜æ†¶åŒ–é€™äº›ç‰©ä»¶èˆ‡å‡½æ•¸ï¼Œè®“å®ƒå€‘åœ¨æ²’æœ‰å¿…è¦è®Šæ›´æ™‚ä¿æŒåƒè€ƒå€¼çš„ä¸è®Šã€‚
-->

---

# `useMemo` & useCallback

1. `useMemo` - è¨˜ä½è¨ˆç®—çµæœ

````md magic-move
```js
const result = useMemo(() => {
  // é€™è£¡æ”¾ä½ æƒ³è¨ˆç®—çš„æ±è¥¿
  return å¾ˆè¤‡é›œçš„è¨ˆç®—();
}, [ä¾è³´1, ä¾è³´2]);
```

```js
const level = useMemo(() => {
  console.log('è¨ˆç®—ç­‰ç´šä¸­...');
  return points > 1000 ? 'VIP' : 'Normal';
}, [points]);
```
````

<!--
å¦‚æœä½ ä¸ç†Ÿæ‚‰æˆ–ä¸æ¸…æ¥š useMemoã€useCallbackï¼Œé€™é‚Šç°¡å–®ä»‹ç´¹ä¸€ä¸‹ç”¨æ³•

useMemo ç”¨ä¾†ã€Œè¨˜ä½ã€ä¸€å€‹è¨ˆç®—çš„å€¼ï¼Œåªæœ‰ç•¶å®ƒçš„ä¾è³´ï¼ˆdependenciesï¼‰æ”¹è®Šæ™‚ï¼Œæ‰æœƒé‡æ–°è¨ˆç®—ï¼Œä¸ç®¡æ€éº¼é‡æ–°æ¸²æŸ“ï¼Œåªè¦ä¾è³´ä¸è®Šï¼Œä»–å°±ä¸æœƒé‡æ–°åŸ·è¡Œï¼Œè€Œæ˜¯è¨˜ä½ä¸Šæ¬¡è¨ˆç®—çš„å€¼ã€‚åŸºæœ¬èªæ³•å°±åƒä¸Šé¢é€™æ¨£

[click]
èˆ‰å€‹å¯¦éš›ä¾‹å­

æ¯”å¦‚èªªï¼Œå¦‚æœæˆ‘å€‘è¦æ ¹æ“šé»æ•¸è¨ˆç®—ä½¿ç”¨è€…çš„ç­‰ç´šï¼Œå°±å¯ä»¥åªåœ¨ points æ”¹è®Šæ™‚å†è¨ˆç®—ï¼Œé¿å…æ¯æ¬¡ re-render éƒ½é‡æ–°è¨ˆç®—ï¼Œé¿å…æµªè²»æ•ˆèƒ½ã€‚
-->

---

# `useMemo` & useCallback

1. `useMemo` - è¨˜ä½è¨ˆç®—çµæœ

```js
const level = useMemo(() => {
  console.log('è¨ˆç®—ç­‰ç´šä¸­...');
  return points > 1000 ? 'VIP' : 'Normal';
}, [points]);
```

2. `useCallback` - è¨˜ä½å‡½æ•¸

````md magic-move
```js
const myFunction = useCallback(() => {
  // é€™è£¡æ”¾ä½ çš„å‡½æ•¸é‚è¼¯
}, [ä¾è³´1, ä¾è³´2]);
```

```js
const handleClick = useCallback(() => {
  console.log('æŒ‰éˆ•è¢«é»äº†ï¼');
}, []);
```
````

<!--
useCallback è·Ÿ `useMemo` å¾ˆåƒï¼Œä½†å®ƒæ˜¯å°ˆé–€ç”¨ä¾†ã€Œè¨˜ä½ã€å‡½æ•¸çš„ï¼Œé¿å…æ¯æ¬¡ render éƒ½ç”Ÿæˆæ–°å‡½æ•¸ã€‚èªæ³•æ˜¯ï¼š

[click]
æ¯”å¦‚èªªï¼Œä½ æœ‰å€‹æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ï¼š

å› ç‚ºé€™å€‹å‡½æ•¸ä¸ä¾è³´ä»»ä½•æ±è¥¿ï¼Œdependencies å°±æ˜¯ç©ºé™£åˆ— []ï¼Œæ‰€ä»¥å®ƒæ°¸é ä¸æœƒè®Šã€‚

å¦‚æœé€™å€‹ handleClick è¢«å‚³çµ¦ useEffect çš„ä¾è³´é …ï¼ŒuseEffect å°±ä¸æœƒå› ç‚ºã€Œå‡½æ•¸åƒè€ƒæ”¹è®Šã€è€ŒåŸ·è¡Œã€‚
-->

---

# ä¿®æ­£å¾Œçš„ç¨‹å¼ç¢¼

````md magic-move
```js {*|1,2,6,7|9,10,15,16|18-20}
// ğŸ‘‡ ä½¿ç”¨ `useMemo` ä¾†è¨˜æ†¶åŒ– requestOptionsï¼Œé¿å…æ¯æ¬¡ render éƒ½é‡æ–°å»ºç«‹
const requestOptions = useMemo(() => {
  return {
    source: 'profile-component',
    timestamp: Date.now(),
  };
}, []);
// ğŸ‘‡ ä½¿ç”¨ `useCallback` ä¾†è¨˜æ†¶åŒ– loadUserDataï¼Œåƒ…åœ¨ userId è®Šå‹•æ™‚æ›´æ–°
const loadUserData = useCallback(
  async options => {
    const data = await fetchUserDetails(userId, options);
    setUserData(data);
  },
  [userId]
);
useEffect(() => {
  loadUserData(requestOptions);
}, [requestOptions, loadUserData]);
```

```js
useEffect(() => {
  const requestOptions = {
    source: 'profile-component',
    timestamp: Date.now(),
  };

  const loadUserData = async options => {
    const data = await fetchUserDetails(userId, options);
    setUserData(data);
  };

  loadUserData(requestOptions);
}, []);
```

```js {1-6,11-19}
const requestOptions = useMemo(() => {
  return {
    source: 'profile-component',
    timestamp: Date.now(),
  };
}, []);

useEffect(() => {
  // åŸå…ˆ loadUserData çš„é‚è¼¯
}, []);

useEffect(() => {
  const trackUserActivity = async () => {
    await analytics.track('user_profile_viewed', {
      userId,
      ...requestOptions, // ä½¿ç”¨ç›¸åŒçš„ requestOptions
    });
  };
  trackUserActivity();
}, []);
```
````

<!--
çŸ¥é“ `useMemo` å’Œ `useCallback` çš„ç”¨æ³•å¾Œï¼Œæˆ‘å€‘å†ä¾†çœ‹å‰›å‰›ä¿®æ­£çš„ç¨‹å¼ç¢¼

[click]
é¦–å…ˆï¼Œæˆ‘å€‘ç”¨ `useMemo` ä¾†è¨˜æ†¶åŒ– requestOptionsï¼Œé¿å…æ¯æ¬¡ render éƒ½é‡æ–°å»ºç«‹å…§å®¹ä¸€æ¨£çš„ç‰©ä»¶

[click]
å†ä¾†ï¼Œæˆ‘å€‘ç”¨ `useCallback` ä¾†è¨˜æ†¶åŒ– loadUserDataï¼Œåƒ…åœ¨ userId è®Šå‹•æ™‚æ›´æ–°

[click]
æœ€å¾Œï¼Œæˆ‘å€‘æŠŠ requestOptions å’Œ loadUserData å‚³çµ¦ useEffect çš„ä¾è³´é …ï¼Œé€™æ¨£ useEffect å°±ä¸æœƒå› ç‚ºã€Œå‡½æ•¸åƒè€ƒæ”¹è®Šã€è€ŒåŸ·è¡Œã€‚

[click]
ç•¶ç„¶ï¼Œåœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥é¸æ“‡å°‡ requestOptions å’Œ loadUserData ç›´æ¥å®šç¾©åœ¨ useEffect å…§éƒ¨ï¼Œé€™æ¨£å°±ä¸éœ€è¦å¯« useEffect çš„ä¾è³´é™£åˆ—äº†ï¼Œä¹Ÿå°±ä¸éœ€è¦é¡å¤–ä½¿ç”¨ `useMemo` æˆ– useCallback

[click]
é€™æ¨£æ”¾åœ¨ useEffect å…§éƒ¨çš„å¯«æ³•åœ¨å¾ˆå¤šæƒ…æ³ä¸‹å…¶å¯¦å·²ç¶“è¶³å¤ ã€‚
ä½†å¦‚æœæœ‰å…¶ä»–çš„ useEffect æˆ–é‚è¼¯ä¹Ÿéœ€è¦ä½¿ç”¨ requestOptions æˆ– loadUserDataï¼Œé‚£éº¼å°‡å®ƒå€‘æå–åˆ°å¤–å±¤ä¸¦é€é `useMemo` / `useCallback` ç®¡ç†ä¾ç„¶æ˜¯å¿…è¦çš„ä½œæ³•ã€‚
-->

---
layout: center
---

# ä½ ä¹Ÿè¨±ä¸éœ€è¦è¨˜æ†¶åŒ–

<!--
ç†è§£äº† reference èˆ‡ primitive çš„å·®ç•°ä¹‹å¾Œï¼Œæˆ‘å€‘å°±èƒ½åˆ¤æ–·å“ªäº›å ´æ™¯ä¸‹çœŸçš„éœ€è¦è¨˜æ†¶åŒ–ï¼Œå“ªäº›åªæ˜¯å¤šæ­¤ä¸€èˆ‰ã€‚

æ¯”å¦‚é€™é‚Šæœ‰ä¸€å€‹å¸¸è¦‹çš„ `useMemo` èª¤ç”¨ç¯„ä¾‹ï¼š
-->

---

# `useMemo` èª¤ç”¨ç¯„ä¾‹

````md magic-move
```js {2-10}
function UserProfile({ userInfo }) {
  const memberLevel = useMemo(() => {
    if (userInfo.points >= 1000) {
      return 'ç™½é‡‘æœƒå“¡';
    } else if (userInfo.points >= 500) {
      return 'é»ƒé‡‘æœƒå“¡';
    } else {
      return 'ä¸€èˆ¬æœƒå“¡';
    }
  }, [userInfo?.points]);

  return <div>{/* ... */}</div>;
}
```

```js {2-11}
function UserProfile({ userInfo }) {
  // âŒ æ²’å¿…è¦ä½¿ç”¨ useMemo
  const memberLevel = useMemo(() => {
    if (userInfo.points >= 1000) {
      return 'ç™½é‡‘æœƒå“¡';
    } else if (userInfo.points >= 500) {
      return 'é»ƒé‡‘æœƒå“¡';
    } else {
      return 'ä¸€èˆ¬æœƒå“¡';
    }
  }, [userInfo?.points]);

  return <div>{/* ... */}</div>;
}
```

```js {2}
function UserProfile({ userInfo }) {
  const memberLevel = calculateMemberLevel(userInfo?.points);

  return <div>{/* ... */}</div>;
}
```

```js {2-10}
function UserProfile({ userInfo }) {
  const memberLevel = (() => {
    if (userInfo.points >= 1000) {
      return 'ç™½é‡‘æœƒå“¡';
    } else if (userInfo.points >= 500) {
      return 'é»ƒé‡‘æœƒå“¡';
    } else {
      return 'ä¸€èˆ¬æœƒå“¡';
    }
  })();

  return <div>{/* ... */}</div>;
}
```

```js
function UserProfile({ userInfo }) {
  const [count, setCount] = useState(0);

  const memberLevel = (() => {
    if (userInfo.points >= 1000) {
      return 'ç™½é‡‘æœƒå“¡';
    } else if (userInfo.points >= 500) {
      return 'é»ƒé‡‘æœƒå“¡';
    } else {
      return 'ä¸€èˆ¬æœƒå“¡';
    }
  })();

  useEffect(() => {
    console.log('è§¸ç™¼ useEffect');
  }, [memberLevel]);

  return <button onClick={() => setCount(count + 1)}>Re-render</button>;
}
```
````

<!--
ç¨‹å¼ç¢¼ä¸­çš„ memberLevel æ˜¯å€‹å­—ä¸²ï¼Œä¹Ÿå°±æ˜¯åŸå§‹å€¼ï¼ˆprimitiveï¼‰ï¼Œè€Œä¸”é‹ç®—éå¸¸ç°¡å–®ã€‚åªæ˜¯æ ¹æ“šé»æ•¸ä¾†å›å‚³ç•¶å‰ä½¿ç”¨è€…çš„æœƒå“¡ç­‰ç´š

[click]
åœ¨é€™ç¨®æƒ…æ³ä¸‹ä½¿ç”¨ `useMemo` ä¸åƒ…æ²’æœ‰æ•ˆèƒ½ä¸Šçš„å¹«åŠ©ï¼Œåè€Œè®“ç¨‹å¼ç¢¼è®Šå¾—æ›´è¤‡é›œä¸”é›£ä»¥ç¶­è­·ã€‚

[click]
æ›´å¥½çš„åšæ³•æ˜¯å°‡é‚è¼¯æŠ½å‡ºç‚ºç¨ç«‹å‡½å¼
é€™æ¨£æ›´ä¹¾æ·¨ï¼Œä¹Ÿæ›´å®¹æ˜“ç¶­è­·ã€‚

è€Œä¸” memberLevel æ˜¯å€‹å­—ä¸²ï¼Œä¹Ÿå°±æ˜¯åŸå§‹å€¼ï¼Œæ‰€ä»¥ä»–æ²’æœ‰åƒè€ƒå€¼çš„å•é¡Œï¼Œåªè¦å€¼ä¸æ”¹è®Šï¼ŒuseEffect ä¹Ÿä¸æœƒé‡æ–°åŸ·è¡Œã€‚

[click]
æˆ–ä¹¾è„†å¯«æˆ IIFEï¼š

[click]
æˆ‘å€‘å¯ä»¥åˆ©ç”¨ useEffect ä¾†æ¸¬è©¦ï¼Œçœ‹çœ‹ re-render æ™‚ï¼Œæœƒä¸æœƒæ‰“å°å‡º â€œè§¸ç™¼ Effectâ€ï¼Œ
-->

---

<Video>
  <source src="/ch-5/5-2/1.mp4" type="video/mp4" />
</Video>

<!--
å¯ä»¥ç™¼ç¾å°±ç®—æŠŠ `useMemo` æ‹¿æ‰ï¼Œç”±æ–¼ä»–å›å‚³æ˜¯ä¸€å€‹åŸå§‹å€¼ï¼Œåªè¦å€¼ä¸æ”¹è®Šï¼ŒuseEffect ä¹Ÿä¸æœƒé‡æ–°åŸ·è¡Œã€‚
-->

---

# `useCallback` èª¤ç”¨ç¯„ä¾‹

````md magic-move
```jsx {*|6-8,12}
function UserProfile({ userInfo }) {
  const [showLevel, setShowLevel] = useState(false);

  const memberLevel = calculateMemberLevel(userInfo?.points);

  const handleToggleLevel = useCallback(() => {
    setShowLevel(prev => !prev);
  }, []);

  return (
    <div>
      <button onClick={handleToggleLevel}>
        {showLevel ? 'éš±è—æœƒå“¡ç­‰ç´š' : 'é¡¯ç¤ºæœƒå“¡ç­‰ç´š'}
      </button>

      {showLevel && <p>æœƒå“¡ç­‰ç´šï¼š{memberLevel}</p>}
    </div>
  );
}
```
````

<!--
é™¤äº† `useMemo` ä¹‹å¤–ï¼Œ

[click]
å¦ä¸€å€‹å¸¸è¦‹çš„èª¤å€æ˜¯æ¿«ç”¨ useCallback
æœ‰æ™‚å€™æœƒçœ‹åˆ°å·¥ç¨‹å¸«å°‡æ²’æœ‰ä»»ä½•ä¾è³´çš„å‡½æ•¸ï¼Œç”¨ `useCallback` åŒ…èµ·ä¾†ï¼š

ç„¶å¾Œä»–ä¹Ÿåªæ˜¯å¾ˆå–®ç´”çš„å‚³çµ¦ button çš„ onClick è€Œå·²ï¼Œã„‡

å¯¦éš›ä¸Šï¼Œé€™æ¨£çš„å¯«æ³•åœ¨æ•ˆèƒ½ä¸Šå¯ä»¥èªªæ˜¯æ¯«ç„¡å¹«åŠ©ã€‚
å› ç‚ºå»ºç«‹ä¸€å€‹ç°¡å–®å‡½æ•¸çš„æˆæœ¬éå¸¸ä½ï¼Œè¨˜æ†¶åŒ–åè€Œå¯èƒ½å¢åŠ  React åœ¨æ¯”è¼ƒæ™‚çš„é¡å¤–è² æ“”ã€‚
-->

---
layout: center
---

# ä»€éº¼æ™‚å€™éœ€è¦è¨˜æ†¶åŒ–ï¼Ÿ

<!--
é‚£æˆ‘å€‘ä»€éº¼æ™‚å¾Œæ‰éœ€è¦è¨˜æ†¶åŒ–å‘¢

å¯¦éš›ä¸Šï¼Œåªæœ‰åœ¨ 3 ç¨®å ´æ™¯ï¼Œæˆ‘å€‘æ‰çœŸæ­£éœ€è¦åœ¨çµ„ä»¶ä¸­å»ä½¿ç”¨ `useMemo` æˆ– useCallbackã€‚
-->

---

# å ´æ™¯ 1: ç”¨åœ¨ Hook çš„ä¾è³´é™£åˆ—

````md magic-move
```jsx {1,3,5,7,9,11,13,15}
const memoObj = useMemo(() => {
  return {...};
}, []);

const memoFn = useCallback(() => {
  // ...
}, []);

useEffect(() => {
  // effect 1
}, [memoObj, memoFn]);

useEffect(() => {
  // effect 2
}, [memoObj, memoFn]);
```

```jsx {*|2-4,6|10-12}
function Parent() {
  const onMount = useCallback(() => {
    // do something
  }, []);

  return <Child onMount={onMount} />;
}

function Child({ onMount }) {
  useEffect(() => {
    onMount();
  }, [onMount]);

  return <div>Child</div>;
}
```
````

<v-click>

1. å¤šå€‹ `useEffect` ç”¨åˆ°ç›¸åŒçš„ç‰©ä»¶æˆ–å‡½æ•¸
2. å°‡ä¸€å€‹åƒè€ƒå€¼ï¼ˆå‡½æ•¸ã€ç‰©ä»¶...ï¼‰å‚³éçµ¦å­çµ„ä»¶æ™‚ï¼Œä¸”ç”¨åœ¨å­çµ„ä»¶çš„ä¾è³´é™£åˆ—è£¡

</v-click>

<!--
å ´æ™¯ 1: ç”¨åœ¨ä¸­ Hook çš„ä¾è³´

é€šå¸¸æœ‰å…©ç¨®æƒ…æ³æœƒç”¨åœ¨ Hook çš„ä¾è³´é™£åˆ—è£¡é¢

ç¬¬ä¸€å€‹æ˜¯å¤šå€‹ useEffect éœ€è¦ç”¨åˆ°ç›¸åŒçš„ç‰©ä»¶æˆ–å‡½æ•¸
åƒå‰é¢æåˆ°çš„é‚£æ¨£

[click]

ç¬¬äºŒå€‹æ˜¯å°‡ä¸€å€‹åƒè€ƒå€¼ä¾‹å¦‚å‡½æ•¸æˆ–ç‰©ä»¶å‚³éçµ¦å­çµ„ä»¶æ™‚

ä¸”è©²å­å…ƒä»¶åœ¨ useEffect ç­‰ Hook ä¸­å°‡å®ƒç•¶ä½œä¾è³´ï¼Œ

é‚£éº¼æ¯æ¬¡é‡æ–°æ¸²æŸ“çˆ¶å…ƒä»¶æ™‚ï¼Œå¦‚æœé€™å€‹å‡½å¼çš„åƒè€ƒåœ°å€æ”¹è®Šï¼Œ

useEffect å°±æœƒè¢«é‡æ–°åŸ·è¡Œã€‚é€™å¯èƒ½æœƒå°è‡´ä¸å¿…è¦çš„å‰¯ä½œç”¨è§¸ç™¼ã€‚

é€™å€‹æƒ…æ³ä¸€å®šè¦éå¸¸æ³¨æ„ï¼Œä¸ç„¶æ¯æ¬¡ re-render éƒ½æœƒè§¸ç™¼ useEffect åˆä¸æ˜“ç™¼ç¾ï¼Œéå¸¸é›£ debugã€‚
-->

---

# å ´æ™¯ 2: ä½ ç¢ºå®šæŸé‹ç®—æˆæœ¬é«˜æ˜‚

````md magic-move
```jsx
const result = someExpensiveCalculation();
```

```jsx
const result = useMemo(() => {
  return someExpensiveCalculation();
}, []);
```

```jsx
const start = performance.now();

const result = useMemo(() => {
  return someExpensiveCalculation();
}, []);

const end = performance.now();
console.log(`åŸ·è¡Œæ™‚é–“: ${end - start}ms`);
```
````

<!--
å¦‚æœæŸæ®µé‹ç®—çš„ç¢ºéœ€è¦å¤§é‡è¨ˆç®—è³‡æºï¼Œæˆ–ä½ è§€å¯Ÿåˆ°å®ƒåœ¨æ¸²æŸ“éç¨‹ä¸­è€—è²»æ˜é¡¯æ™‚é–“ï¼Œé‚£éº¼è¨˜æ†¶åŒ–çš„ç¢ºå¯ä»¥é¿å…æ¯æ¬¡ render éƒ½é‡æ–°è¨ˆç®—ï¼Œæå‡æ•ˆèƒ½ã€‚

[click]
é€™é¡æƒ…å¢ƒä¸‹ï¼Œå°±å¯ä»¥ä½¿ç”¨ `useMemo` å°çµæœåšè¨˜æ†¶åŒ–ã€‚

[click]
ä¸éå‰ææ˜¯ä½ å·²ç¶“æ¸¬é‡éï¼Œç¢ºå®šè©²é‹ç®—æ˜¯çœŸçš„æ˜‚è²´ï¼Œè€Œä¸æ˜¯ã€Œæ„Ÿè¦ºä¸Šã€å¾ˆè¤‡é›œã€‚
æˆ‘å€‘å¯ä»¥å¾ˆç°¡å–®çš„ä½¿ç”¨ console ä¾†æ¸¬é‡é‹ç®—æ™‚é–“ï¼Œ
-->

---

# å ´æ™¯ 3: å­å…ƒä»¶è¢« `React.memo` åŒ…ä½æ™‚

```js {*|16|4-6|11}
function Parent() {
  const [count, setCount] = useState(0);

  const someEvent = () => {
    // do something
  };

  return (
    <div>
      <button onClick={() => setCount(count + 1)}>Re-render</button>
      <MemoChild onEvent={someEvent} />
    </div>
  );
}

const MemoChild = React.memo(function Child({ onEvent }) {
  console.log('Child re-render');
  return <p>Child</p>;
});
```

<!--
ç¬¬ä¸‰ç¨®å ´æ™¯å°±æ˜¯ç•¶å­å…ƒä»¶è¢« `React.memo` åŒ…ä½æ™‚ï¼Œ

[click]
å¦‚æœæˆ‘å€‘ä¸å¸Œæœ›å­çµ„ä»¶ä¹Ÿè¢«é‡æ–°æ¸²æŸ“ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ `React.memo` ä¾†å°‡çµ„ä»¶è¨˜æ†¶åŒ–èµ·ä¾†

[click]
é€™æ™‚è‹¥ä¸ä½¿ç”¨ `useCallback` å°‡å‡½æ•¸è¨˜æ†¶åŒ–ï¼Œé‚£React æ¯æ¬¡éƒ½æœƒåˆ¤å®š props æ”¹è®Šï¼Œ

[click]
å¾è€Œå°è‡´ MemoChild ç„¡æ³•è¢«æ­£ç¢ºåœ°è¨˜æ†¶åŒ–ã€‚
-->

---

<Video>
  <source src="/ch-5/5-2/2.mp4" type="video/mp4" />
</Video>

<!--
å¯ä»¥çœ‹åˆ°æ¯æ¬¡é»æ“ŠæŒ‰éˆ•æ™‚ï¼Œ MemoChild é‚„æ˜¯æœƒè¢«é‡æ–°æ¸²æŸ“
-->

---

<VCenter>

```js {4-6}
function Parent() {
  const [count, setCount] = useState(0);

  const someEvent = useCallback(() => {
    // do something
  }, []);

  return (
    <div>
      <button onClick={() => setCount(count + 1)}>Re-render</button>
      <MemoChild onEvent={someEvent} />
    </div>
  );
}

const MemoChild = React.memo(function Child({ onEvent }) {
  console.log('Child re-render');
  return <p>Child</p>;
});
```

</VCenter>

<!--
é€™ç¨®æ™‚å€™å°±å¯ä»¥ç”¨ `useCallback` å°‡å‡½æ•¸åŒ…èµ·ä¾†

é€™æ¨£ `React.memo` æ‰æœƒæ­£ç¢ºçš„é‹ä½œ
-->

---

# å°ç¸½çµ

<v-clicks pl-8 pt-8>

1. `useMemo` èˆ‡ `useCallback` ä¸æ˜¯è¬éˆä¸¹
2. è¦ä¸è¦ä½¿ç”¨ `useMemo` æˆ– `useCallback`ï¼Œè¦å¾ primitive èˆ‡ reference çš„è§€å¿µå‡ºç™¼
3. å¦‚æœé‹ç®—å¾ˆç°¡å–®ï¼Œè¨˜æ†¶åŒ–åè€Œæœƒè®“ç¨‹å¼ç¢¼è®Šå¾—å†—è´…
4. å…ˆæ¸¬é‡é‹ç®—æ™‚é–“ï¼Œå†æ±ºå®šè¦ä¸è¦ä½¿ç”¨ `useMemo`
5. `useCallback` åªæœ‰å…©ç¨®ä½¿ç”¨å ´æ™¯:
   1. å‡½æ•¸ç”¨åœ¨ Hook çš„ä¾è³´é™£åˆ—ä¸­
   2. å‡½æ•¸è¢«ç•¶ä½œ Props å‚³çµ¦è¢« `React.memo` åŒ…ä½å­çµ„ä»¶æ™‚æ™‚

</v-clicks>

<!--
æœ€å¾Œæˆ‘å€‘ä¾†å°ç¸½çµé€™ä¸€ç« çš„é‡é»

[click]
1. `useMemo` èˆ‡ `useCallback` ä¸¦éæ•ˆèƒ½è¬éˆä¸¹ï¼Œç”šè‡³åœ¨éŒ¯èª¤çš„æƒ…å¢ƒä¸‹æœƒç”¢ç”Ÿåæ•ˆæœ
2. 
[click]
1. åˆ°åº•è¦ä¸è¦ä½¿ç”¨ `useMemo` æˆ– useCallbackï¼Œè¦å¾ primitive èˆ‡ reference çš„è§€å¿µå‡ºç™¼

[click]
3. æ‰€ä»¥æ¯æ¬¡è¨˜æ†¶åŒ–æ™‚ï¼Œéƒ½è¦åˆ¤æ–·æˆ‘å€‘æ˜¯å¦çœŸçš„éœ€è¦ä»–ã€‚å¦‚æœä¸€æ®µé‚è¼¯åªæ˜¯ç°¡å–®çš„åŠ æ¸›ä¹˜é™¤ï¼Œè¨˜æ†¶åŒ–åè€Œå¯èƒ½è®“ç¨‹å¼ç¢¼è®Šå¾—å†—è´…ï¼›åª

[click]
4. å…ˆæ¸¬é‡é‹ç®—æ™‚é–“ï¼Œå†æ±ºå®šè¦ä¸è¦ä½¿ç”¨ useMemoï¼Œ

[click]
5. `useCallback` åªæœ‰å…©ç¨®ä½¿ç”¨å ´æ™¯:
   1. å‡½æ•¸ç”¨åœ¨ Hook çš„ä¾è³´é™£åˆ—ä¸­
   2. å‡½æ•¸è¢«ç•¶ä½œ Props å‚³çµ¦è¢« `React.memo` åŒ…ä½å­çµ„ä»¶æ™‚

é€™ä¹Ÿç‚ºæˆ‘å€‘å¼•å‡ºä¸‹ä¸€ç« çš„ä¸»é¡Œ â€”â€” React.memoã€‚
-->
